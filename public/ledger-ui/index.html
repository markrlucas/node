<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XRP Ledger Transaction Viewer</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    .container {
      max-width: 95%;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
      padding: 32px 40px 40px 40px;
    }
    h1 {
      text-align: center;
      font-weight: 700;
      color: #2a3b8f;
      margin-bottom: 24px;
    }
    form {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    input[type="text"], input[type="number"] {
      padding: 10px 14px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      width: 320px;
      max-width: 100%;
    }
    input[type="number"] {
      width: 100px;
    }
    button {
      background: #2a3b8f;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #1a265c;
    }
    .error {
      color: #c0392b;
      text-align: center;
      margin-bottom: 16px;
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      background: #fafbfc;
      margin-top: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.97rem;
      background: #fafbfc;
      table-layout: auto;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #e0e4ea;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #e8eaf6;
      color: #2a3b8f;
      font-weight: 700;
      white-space: nowrap;
    }
    td {
      max-width: 350px;
      vertical-align: top;
    }
    .cell-content {
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .loading {
      text-align: center;
      color: #888;
      margin-top: 24px;
    }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      form { flex-direction: column; align-items: stretch; }
      input[type="text"], input[type="number"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>XRP Ledger Transaction Viewer</h1>
    <form id="txForm">
      <input type="text" id="address" placeholder="Enter XRP Address" required />
      <input type="number" id="limit" placeholder="Limit" min="1" max="100" value="10" />
      <button type="submit">Fetch Transactions</button>
    </form>
    <div class="error" id="error"></div>
    <div class="loading" id="loading" style="display:none;">Loading...</div>
    <div id="columnSelectorWrap" style="display:none;margin-bottom:16px;"></div>
    <div class="table-wrap" id="tableWrap" style="display:none;"></div>
  </div>
 <script src="resizer.js"></script>
 <script>
  const form = document.getElementById('txForm');
  const errorDiv = document.getElementById('error');
  const loadingDiv = document.getElementById('loading');
  const tableWrap = document.getElementById('tableWrap');
  const columnSelectorWrap = document.getElementById('columnSelectorWrap');

  // Column selector state
  let allKeys = [];
  let visibleKeys = [];
  let lastData = [];

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.textContent = '';
    tableWrap.style.display = 'none';
    columnSelectorWrap.style.display = 'none';
    loadingDiv.style.display = 'block';
    tableWrap.innerHTML = '';
    const address = document.getElementById('address').value.trim();
    const limit = document.getElementById('limit').value.trim() || 10;
    if (!address) {
      errorDiv.textContent = 'Please enter a valid XRP address.';
      loadingDiv.style.display = 'none';
      return;
    }
    try {
      const res = await fetch(`/api/ledger/transactions/${address}?limit=${limit}`);
      if (!res.ok) throw new Error('Failed to fetch transactions.');
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        errorDiv.textContent = 'No transactions found.';
        loadingDiv.style.display = 'none';
        return;
      }
      lastData = data;
      renderTable(data);
    } catch (err) {
      errorDiv.textContent = err.message || 'Error fetching transactions.';
    } finally {
      loadingDiv.style.display = 'none';
    }
  });

  function renderTable(data) {
    // Collect all unique keys
    allKeys = Array.from(data.reduce((set, tx) => {
      Object.keys(tx).forEach(k => set.add(k));
      return set;
    }, new Set()));

    // Load visibleKeys from localStorage or default to all
    const saved = localStorage.getItem('ledger-ui-visible-keys');
    if (!visibleKeys.length) {
      visibleKeys = saved ? JSON.parse(saved) : [...allKeys];
    } else {
      // Add any new keys to visibleKeys
      allKeys.forEach(k => { if (!visibleKeys.includes(k)) visibleKeys.push(k); });
    }

    renderColumnSelector();

    // Build table
    let html = '<table><thead><tr>';
    visibleKeys.forEach(k => {
      html += `<th>${k}</th>`;
    });
    html += '</tr></thead><tbody>';
    data.forEach(tx => {
      html += '<tr>';
      visibleKeys.forEach(k => {
        let val = tx[k];
        if (typeof val === 'object' && val !== null) {
          val = `<pre style="white-space:pre-wrap;max-width:400px;overflow-x:auto;word-break:break-all;">${JSON.stringify(val, null, 2)}</pre>`;
        }
        html += `<td><div class="cell-content">${val === undefined ? '' : val}</div></td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    tableWrap.innerHTML = html;
    tableWrap.style.display = 'block';
    resizableGrid(document.querySelector('table'));
  }

  function renderColumnSelector() {
    if (!allKeys.length) {
      columnSelectorWrap.style.display = 'none';
      return;
    }
    let html = '<div style="background:#e8eaf6;padding:10px 16px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);display:flex;flex-wrap:wrap;gap:12px;align-items:center;">';
    html += '<span style="font-weight:700;color:#2a3b8f;margin-right:12px;">Columns:</span>';
    allKeys.forEach(k => {
      html += `<label style="margin-right:10px;white-space:nowrap;"><input type="checkbox" class="col-toggle" value="${k}"${visibleKeys.includes(k) ? ' checked' : ''}/> ${k}</label>`;
    });
    html += '<button id="saveCols" style="margin-left:16px;background:#2a3b8f;color:#fff;border:none;border-radius:6px;padding:6px 16px;font-weight:700;cursor:pointer;">Save Layout</button>';
    html += '<button id="resetCols" style="margin-left:8px;background:#cfd8dc;color:#222;border:none;border-radius:6px;padding:6px 16px;font-weight:700;cursor:pointer;">Reset</button>';
    html += '</div>';
    columnSelectorWrap.innerHTML = html;
    columnSelectorWrap.style.display = 'block';

    // Add event listeners
    columnSelectorWrap.querySelectorAll('.col-toggle').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const col = e.target.value;
        if (e.target.checked) {
          if (!visibleKeys.includes(col)) visibleKeys.push(col);
        } else {
          visibleKeys = visibleKeys.filter(k => k !== col);
        }
        renderTable(lastData);
      });
    });
    document.getElementById('saveCols').onclick = () => {
      localStorage.setItem('ledger-ui-visible-keys', JSON.stringify(visibleKeys));
      alert('Column layout saved!');
    };
    document.getElementById('resetCols').onclick = () => {
      visibleKeys = [...allKeys];
      localStorage.removeItem('ledger-ui-visible-keys');
      renderTable(lastData);
    };
  }
</script>
</body>
</html>
