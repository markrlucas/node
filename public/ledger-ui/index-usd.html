<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XRP Ledger Transaction Viewer</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 0;
      color: #222;
    }
    .container {
      max-width: 95%;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
      padding: 32px 40px 40px 40px;
    }
    h1 {
      text-align: center;
      font-weight: 700;
      color: #2a3b8f;
      margin-bottom: 24px;
    }
    form {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    input[type="text"], input[type="number"] {
      padding: 10px 14px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1rem;
      width: 320px;
      max-width: 100%;
    }
    input[type="number"] {
      width: 100px;
    }
    button {
      background: #2a3b8f;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #1a265c;
    }
    .error {
      color: #c0392b;
      text-align: center;
      margin-bottom: 16px;
    }
    .table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      background: #fafbfc;
      margin-top: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.97rem;
      background: #fafbfc;
      table-layout: auto;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #e0e4ea;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #e8eaf6;
      color: #2a3b8f;
      font-weight: 700;
      white-space: nowrap;
    }
    td {
      /* Remove max-width to allow column resizer to expand/shrink columns */
      /* max-width: 350px; */
      max-width: none;
      vertical-align: top;
    }
    .cell-content {
      max-height: 100px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .loading {
      text-align: center;
      color: #888;
      margin-top: 24px;
    }
    @media (max-width: 600px) {
      .container { padding: 12px; }
      form { flex-direction: column; align-items: stretch; }
      input[type="text"], input[type="number"] { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>XRP Ledger Transaction Viewer</h1>
    <div id="totalAmount" style="text-align: right; font-size: 1.2em; margin-bottom: 16px; display: none;"></div>
    <form id="txForm">
      <div style="position:relative;flex:1;min-width:220px;max-width:340px;">
        <input type="text" id="address" placeholder="Enter XRP Address or select from address book" autocomplete="off" required style="width:100%;" />
        <div id="addressDropdown" style="display:none;position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #cfd8dc;z-index:10;max-height:220px;overflow-y:auto;border-radius:0 0 6px 6px;box-shadow:0 2px 8px rgba(0,0,0,0.08);"></div>
      </div>
      <input type="number" id="limit" placeholder="Limit" min="1" max="300" value="50" />
      <button type="submit">Fetch Transactions</button>
      <button type="button" id="quickAddBtn">Quick Add</button>
    </form>
    <!-- Quick Add Modal -->
    <div id="quickAddModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:10px;box-shadow:0 2px 16px rgba(0,0,0,0.15);min-width:320px;max-width:90vw;">
        <h2 style="margin-top:0;margin-bottom:18px;font-size:1.2em;color:#2a3b8f;">Add to Address Book</h2>
        <form id="quickAddForm">
          <div style="margin-bottom:14px;">
            <label for="quickAddName" style="font-weight:700;">Name:</label><br/>
            <input type="text" id="quickAddName" style="width:100%;padding:8px 10px;border-radius:5px;border:1px solid #cfd8dc;" required />
          </div>
          <div style="margin-bottom:18px;">
            <label for="quickAddAddress" style="font-weight:700;">Ledger Address:</label><br/>
            <input type="text" id="quickAddAddress" style="width:100%;padding:8px 10px;border-radius:5px;border:1px solid #cfd8dc;" required />
          </div>
          <div style="text-align:right;">
            <button type="button" id="quickAddCancel" style="background:#cfd8dc;color:#222;margin-right:10px;">Cancel</button>
            <button type="submit" style="background:#2a3b8f;color:#fff;">Add</button>
          </div>
          <div id="quickAddError" style="color:#c0392b;margin-top:10px;"></div>
        </form>
      </div>
    </div>
    <div style="text-align: center; margin-bottom: 16px; display:flex;gap:24px;justify-content:center;align-items:center;flex-wrap:wrap;">
      <div>
        <label class="switch">
          <input type="checkbox" id="showNameToggle" checked>
          <span class="slider round"></span>
        </label>
        <span style="margin-left: 8px;">Show Names</span>
      </div>
      <div>
        <label class="switch">
          <input type="checkbox" id="cachedToggle">
          <span class="slider round"></span>
        </label>
        <span style="margin-left: 8px;">Cached Mode</span>
      </div>
      <div>
        <label class="switch">
          <input type="checkbox" id="filterDeliverMaxToggle">
          <span class="slider round"></span>
        </label>
        <span style="margin-left: 8px;">Hide DeliverMax â‰¤ 1</span>
      </div>
    </div>
    <div class="error" id="error"></div>
    <div class="loading" id="loading" style="display:none;">Loading...</div>
    <div id="columnSelectorWrap" style="display:none;margin-bottom:16px;"></div>
    <div class="table-wrap" id="tableWrap" style="display:none;"></div>
  </div>
  <script src="resizer.js"></script>
  <script>
  const form = document.getElementById('txForm');
  const errorDiv = document.getElementById('error');
  const loadingDiv = document.getElementById('loading');
  const tableWrap = document.getElementById('tableWrap');
  const columnSelectorWrap = document.getElementById('columnSelectorWrap');
  const totalAmountDiv = document.getElementById('totalAmount');

  // Address book state
  let addressBook = [];
  let addressBookMap = {};
  let showNames = true;

  // Cached mode state
  let useCachedAddressBook = false;
    
  // Filter state
  let filterDeliverMax = false;
     
  // Column selector state
  let allKeys = [];
  let visibleKeys = [];
  let lastData = [];
  // Track initialization and previously seen columns so toggles work correctly
  let columnsInitialized = false;
  let previousAllKeys = [];

  // On page load: load address book, check for address in URL
  window.addEventListener('load', async () => {
    showNames = true;
    document.getElementById('showNameToggle').checked = true;
    const cachedToggleEl = document.getElementById('cachedToggle');
    if (cachedToggleEl) {
      cachedToggleEl.checked = false;
      // Ensure runtime flag matches checkbox
      useCachedAddressBook = cachedToggleEl.checked;
    }
    const filterDeliverMaxEl = document.getElementById('filterDeliverMaxToggle');
    if (filterDeliverMaxEl) {
      filterDeliverMaxEl.checked = false;
      filterDeliverMax = false;
    }
    await loadAddressBook();
    const params = new URLSearchParams(window.location.search);
    const address = params.get('address');
    if (address) {
      const addrInput = document.getElementById('address');
      addrInput.value = address;
      // Force-refresh the dropdown to reflect navigated address and latest address book
      updateAddressDropdown();
      form.dispatchEvent(new Event('submit', { cancelable: true }));
    }
  });

  // Ensure dropdown refreshes when returning via back/forward cache
  window.addEventListener('pageshow', async () => {
    // Reload address book (honors Cached Mode toggle) and refresh dropdown
    await loadAddressBook();
    updateAddressDropdown();
  });

  async function loadAddressBook() {
    try {
        const url = useCachedAddressBook
          ? '/api/ledger/addresses'
          : `/api/ledger/addresses?_=${Date.now()}`;
        const fetchOpts = useCachedAddressBook
          ? {}
          : { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } };
        const res = await fetch(url, fetchOpts);
        if (!res.ok) throw new Error('Failed to load address book');
        addressBook = await res.json();
        addressBookMap = {};
        addressBook.forEach(entry => {
          if (entry.address) addressBookMap[entry.address] = entry.name;
        });
        updateAddressDropdown();
      } catch (e) {
        addressBook = [];
        addressBookMap = {};
        updateAddressDropdown();
      }
  }
  // Show Names toggle
  const showNameToggle = document.getElementById('showNameToggle');
  showNameToggle.addEventListener('change', () => {
    showNames = showNameToggle.checked;
    if (lastData.length) renderTable(lastData);
  });
  // Cached Mode toggle
  const cachedToggle = document.getElementById('cachedToggle');
  if (cachedToggle) {
    cachedToggle.addEventListener('change', async () => {
      useCachedAddressBook = cachedToggle.checked;
      await loadAddressBook();
    });
  }
  // Filter DeliverMax toggle
  const filterDeliverMaxToggle = document.getElementById('filterDeliverMaxToggle');
  if (filterDeliverMaxToggle) {
    filterDeliverMaxToggle.addEventListener('change', () => {
      filterDeliverMax = filterDeliverMaxToggle.checked;
      if (lastData.length) renderTable(lastData);
    });
  }

  // Helper: parse XRPL amount to XRP (number)
  function parseAmountToXRP(val) {
    if (val == null) return 0;
    if (typeof val === 'string') {
      // drops string
      const n = Number(val);
      return isNaN(n) ? 0 : n / 1_000_000;
    }
    if (typeof val === 'number') {
      // assume drops
      return val / 1_000_000;
    }
    if (typeof val === 'object') {
      const { currency, value } = val;
      if (currency === 'XRP' && value != null) {
        const n = Number(value);
        return isNaN(n) ? 0 : n;
      }
      return 0; // Non-XRP currencies ignored for this filter
    }
    return 0;
  }
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.textContent = '';
    tableWrap.style.display = 'none';
    totalAmountDiv.style.display = 'none';
    columnSelectorWrap.style.display = 'none';
    loadingDiv.style.display = 'block';
    tableWrap.innerHTML = '';
    const address = document.getElementById('address').value.trim();
    const limit = document.getElementById('limit').value.trim() || 50;
    if (!address) {
      errorDiv.textContent = 'Please enter a valid XRP address.';
      loadingDiv.style.display = 'none';
      return;
    }
    try {
      const res = await fetch(`/api/ledger/transactions/${address}?limit=${limit}`);
      if (!res.ok) throw new Error('Failed to fetch transactions.');
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        errorDiv.textContent = 'No transactions found.';
        loadingDiv.style.display = 'none';
        return;
      }
      lastData = data;
      renderTable(data);
    } catch (err) {
      errorDiv.textContent = err.message || 'Error fetching transactions.';
    } finally {
      loadingDiv.style.display = 'none';
    }
  });

  // Quick Add logic
  const quickAddBtn = document.getElementById('quickAddBtn');
  const quickAddModal = document.getElementById('quickAddModal');
  const quickAddForm = document.getElementById('quickAddForm');
  const quickAddName = document.getElementById('quickAddName');
  const quickAddAddress = document.getElementById('quickAddAddress');
  const quickAddCancel = document.getElementById('quickAddCancel');
  const quickAddError = document.getElementById('quickAddError');

  quickAddBtn.addEventListener('click', () => {
    quickAddName.value = '';
    quickAddAddress.value = document.getElementById('address').value.trim();
    quickAddError.textContent = '';
    quickAddModal.style.display = 'flex';
    quickAddName.focus();
  });
  quickAddCancel.addEventListener('click', () => {
    quickAddModal.style.display = 'none';
  });
  quickAddForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = quickAddName.value.trim();
    const address = quickAddAddress.value.trim();
    if (!name || !address) {
      quickAddError.textContent = 'Both fields are required.';
      return;
    }
    try {
      const res = await fetch('/api/ledger/addresses', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, address })
      });
      const result = await res.json();
      if (!res.ok) {
        quickAddError.textContent = result.error || 'Failed to add address.';
        return;
      }
      await loadAddressBook();
      quickAddModal.style.display = 'none';
      alert('Address added to address book!');
    } catch (err) {
      quickAddError.textContent = err.message || 'Failed to add address.';
    }
  });

  function renderTable(data) {
    const sourceForKeys = (lastData && lastData.length) ? lastData : data;
    // Collect all unique keys
    allKeys = Array.from(sourceForKeys.reduce((set, tx) => {
       Object.keys(tx).forEach(k => set.add(k));
       return set;
     }, new Set()));

     // Initialize or update visibleKeys without re-adding user-hidden columns
     if (!columnsInitialized) {
       const saved = localStorage.getItem('ledger-ui-visible-keys');
       visibleKeys = saved ? JSON.parse(saved) : [...allKeys];
       columnsInitialized = true;
     } else {
       // Remove keys no longer present in the dataset
       visibleKeys = visibleKeys.filter(k => allKeys.includes(k));
       // Auto-add only brand-new keys that were not seen before
       allKeys.forEach(k => {
         if (!visibleKeys.includes(k) && !previousAllKeys.includes(k)) {
           visibleKeys.push(k);
         }
       });
     }

     renderColumnSelector();

     // Apply filter (Hide DeliverMax >= 1 XRP)
     const rows = filterDeliverMax
      ? data.filter(tx => {
          const dm = tx['DeliverMax'];
          if (dm === undefined) return true; // keep if no DeliverMax
          return parseAmountToXRP(dm) > 1; // hide <= 1 by keeping only > 1
        })
      : data;
     
     // Build table
     let html = '<table><thead><tr>';
     visibleKeys.forEach(k => {
       html += `<th>${k}</th>`;
     });
     html += '</tr></thead><tbody>';
     let totalDeliveredAmount = 0;
     let hasDeliveredAmount = false;
     rows.forEach(tx => {
       html += '<tr>';
       visibleKeys.forEach(k => {
         let val = tx[k];
         // For Account, Destination, Issuer: show name if enabled, else address
         if ((k === 'Account' || k === 'Destination' || k === 'Issuer') && val && typeof val === 'string' && val.startsWith('r')) {
           let displayVal = val;
           if (showNames && addressBookMap[val]) {
             displayVal = addressBookMap[val];
           }
           val = `<a href="?address=${val}" target="_blank">${displayVal}</a>`;
         } else if (k === 'delivered_amount' && typeof val === 'string' && !isNaN(val)) {
           const xrpAmount = parseFloat(val) / 1000000;
           totalDeliveredAmount += xrpAmount;
           hasDeliveredAmount = true;
           val = xrpAmount.toLocaleString(undefined, { minimumFractionDigits: 6, maximumFractionDigits: 6 });
         } else if (typeof val === 'object' && val !== null) {
           val = `<pre style="white-space:pre-wrap;max-width:400px;overflow-x:auto;word-break:break-all;">${JSON.stringify(val, null, 2)}</pre>`;
         }
         html += `<td><div class="cell-content">${val === undefined ? '' : val}</div></td>`;
       });
       html += '</tr>';
     });
     html += '</tbody></table>';
     tableWrap.innerHTML = html;
     tableWrap.style.display = 'block';
     // Show total when any delivered_amount values were found in the rows
     if (hasDeliveredAmount) {
       totalAmountDiv.textContent = `Total Delivered XRP: ${totalDeliveredAmount.toLocaleString(undefined, { minimumFractionDigits: 6, maximumFractionDigits: 6 })}`;
       totalAmountDiv.style.display = 'block';
     } else {
       totalAmountDiv.style.display = 'none';
     }
     // Defer to next frame so layout is finalized before attaching resizers
     requestAnimationFrame(() => {
       const tbl = document.querySelector('table');
       if (tbl) resizableGrid(tbl);
     });
     // Remember keys for next render (to detect brand-new columns)
     previousAllKeys = [...allKeys];
  }

  function renderColumnSelector() {
    if (!allKeys.length) {
      columnSelectorWrap.style.display = 'none';
      return;
    }
    let html = '<div style="background:#e8eaf6;padding:10px 16px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);display:flex;flex-wrap:wrap;gap:12px;align-items:center;">';
    html += '<span style="font-weight:700;color:#2a3b8f;margin-right:12px;">Columns:</span>';
    allKeys.forEach(k => {
      html += `<label style="margin-right:10px;white-space:nowrap;"><input type="checkbox" class="col-toggle" value="${k}"${visibleKeys.includes(k) ? ' checked' : ''}/> ${k}</label>`;
    });
    html += '<button id="saveCols" style="margin-left:16px;background:#2a3b8f;color:#fff;border:none;border-radius:6px;padding:6px 16px;font-weight:700;cursor:pointer;">Save Layout</button>';
    html += '<button id="resetCols" style="margin-left:8px;background:#cfd8dc;color:#222;border:none;border-radius:6px;padding:6px 16px;font-weight:700;cursor:pointer;">Reset</button>';
    html += '</div>';
    columnSelectorWrap.innerHTML = html;
    columnSelectorWrap.style.display = 'block';

    // Add event listeners
    columnSelectorWrap.querySelectorAll('.col-toggle').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const col = e.target.value;
        if (e.target.checked) {
          if (!visibleKeys.includes(col)) visibleKeys.push(col);
        } else {
          visibleKeys = visibleKeys.filter(k => k !== col);
        }
        renderTable(lastData);
      });
    });
    document.getElementById('saveCols').onclick = () => {
      localStorage.setItem('ledger-ui-visible-keys', JSON.stringify(visibleKeys));
      alert('Column layout saved!');
    };
    document.getElementById('resetCols').onclick = () => {
      visibleKeys = [...allKeys];
      localStorage.removeItem('ledger-ui-visible-keys');
      renderTable(lastData);
    };
  }

  // Address dropdown (combo box) logic
  const addressInput = document.getElementById('address');
  const addressDropdown = document.getElementById('addressDropdown');

  function updateAddressDropdown() {
    if (!addressDropdown) return;
    const val = (addressInput.value || '').trim().toLowerCase();
    if (!Array.isArray(addressBook) || addressBook.length === 0) {
      addressDropdown.style.display = 'none';
      return;
    }
    const filtered = addressBook.filter(entry =>
      (entry.name || '').toLowerCase().includes(val) || (entry.address || '').toLowerCase().includes(val)
    );
    if (!filtered.length && val.length === 0) {
      addressDropdown.style.display = 'none';
      return;
    }
    let html = '';
    filtered.forEach(entry => {
      const addr = (entry.address || '').replace(/"/g, '&quot;');
      const nm = entry.name || '';
      html += `<div class="dropdown-item" data-address="${addr}" style="padding:8px 10px;cursor:pointer;border-bottom:1px solid #eef1f4;">
        <div style="font-weight:700;color:#2a3b8f;">${nm}</div>
        <div style="font-size:0.92em;color:#555;">${addr}</div>
      </div>`;
    });
    addressDropdown.innerHTML = html || '<div style="padding:8px 10px;color:#777;">No matches</div>';
    addressDropdown.style.display = 'block';
    addressDropdown.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('mousedown', (e) => {
        e.preventDefault();
        const chosen = item.getAttribute('data-address');
        if (chosen) addressInput.value = chosen;
        addressDropdown.style.display = 'none';
      });
    });
  }

  if (addressInput) {
    addressInput.addEventListener('input', updateAddressDropdown);
    addressInput.addEventListener('focus', () => { loadAddressBook(); });
    addressInput.addEventListener('click', () => { loadAddressBook(); });
    addressInput.addEventListener('blur', () => setTimeout(() => { if (addressDropdown) addressDropdown.style.display = 'none'; }, 120));
  }
  </script>
</body>
</html>
